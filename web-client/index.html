<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification System - Web Client</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .notification {
            border-left: 4px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
            transition: all 0.3s ease;
        }
        .notification.info { border-left-color: #007bff; }
        .notification.alert { border-left-color: #dc3545; }
        .notification.warning { border-left-color: #ffc107; }
        .notification.new {
            animation: highlight 2s ease;
        }
        @keyframes highlight {
            0% { background-color: #ffffcc; }
            100% { background-color: #f9f9f9; }
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>Notification System</h1>
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Authentication
                    </div>
                    <div class="card-body">
                        <div id="auth-status" class="mb-3">
                            <span class="badge bg-danger">Not Authenticated</span>
                        </div>
                        <div class="mb-3">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="username" value="user">
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" value="password">
                        </div>
                        <button type="button" class="btn btn-primary" id="login-btn">Login</button>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        Create Notification
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="recipient" class="form-label">Recipient</label>
                            <input type="text" class="form-control" id="recipient">
                        </div>
                        <div class="mb-3">
                            <label for="notif-type" class="form-label">Type</label>
                            <select class="form-control" id="notif-type">
                                <option value="INFO">Info</option>
                                <option value="ALERT">Alert</option>
                                <option value="WARNING">Warning</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="message" class="form-label">Message</label>
                            <textarea class="form-control" id="message" rows="3"></textarea>
                        </div>
                        <button type="button" class="btn btn-success" id="send-btn" disabled>Send Notification</button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        My Notifications
                    </div>
                    <div class="card-body">
                        <div id="notifications-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    
    <script>
        // Global variables
        let token = '';
        let stompClient = null;
        let currentUser = '';
        const serverUrl = 'http://localhost:8080';
        
        // DOM elements
        const loginBtn = document.getElementById('login-btn');
        const sendBtn = document.getElementById('send-btn');
        const authStatus = document.getElementById('auth-status');
        const notificationsContainer = document.getElementById('notifications-container');
        
        // Event listeners
        loginBtn.addEventListener('click', authenticate);
        sendBtn.addEventListener('click', sendNotification);
        
        // Authentication function
        async function authenticate() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }
            
            try {
                const response = await fetch(`${serverUrl}/api/authenticate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                if (!response.ok) {
                    throw new Error('Authentication failed');
                }
                
                const data = await response.json();
                token = data.token;
                currentUser = username;
                
                // Update UI
                authStatus.innerHTML = `<span class="badge bg-success">Authenticated</span> <small>(${username})</small>`;
                sendBtn.disabled = false;
                document.getElementById('recipient').value = username;
                
                // Connect to WebSocket
                connectWebSocket();
                
                // Fetch existing notifications
                fetchNotifications();
                
            } catch (error) {
                console.error('Authentication error:', error);
                authStatus.innerHTML = `<span class="badge bg-danger">Authentication Failed</span>`;
                alert('Authentication failed: ' + error.message);
            }
        }
        
        // WebSocket connection
        function connectWebSocket() {
            const socket = new SockJS(`${serverUrl}/ws`);
            stompClient = Stomp.over(socket);
            
            stompClient.connect({ 'Authorization': `Bearer ${token}` }, frame => {
                console.log('Connected to WebSocket');
                
                // Subscribe to personal notifications
                stompClient.subscribe(`/user/${currentUser}/queue/notifications`, notification => {
                    const notificationData = JSON.parse(notification.body);
                    addNotification(notificationData, true);
                });
            }, error => {
                console.error('WebSocket connection error:', error);
            });
        }
        
        // Fetch existing notifications
        async function fetchNotifications() {
            try {
                const response = await fetch(`${serverUrl}/api/notifications/recipient/${currentUser}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch notifications');
                }
                
                const notifications = await response.json();
                
                // Clear existing notifications
                notificationsContainer.innerHTML = '';
                
                // Add each notification
                notifications.forEach(notification => {
                    addNotification(notification, false);
                });
                
            } catch (error) {
                console.error('Error fetching notifications:', error);
            }
        }
        
        // Send a new notification
        async function sendNotification() {
            const recipient = document.getElementById('recipient').value.trim();
            const type = document.getElementById('notif-type').value;
            const payload = document.getElementById('message').value.trim();
            
            if (!recipient || !payload) {
                alert('Please enter both recipient and message');
                return;
            }
            
            try {
                const response = await fetch(`${serverUrl}/api/notifications`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        recipient,
                        type,
                        payload,
                        status: 'PENDING'
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to send notification');
                }
                
                // Clear form
                document.getElementById('message').value = '';
                
                // If sending to self, it will arrive via WebSocket
                if (recipient !== currentUser) {
                    alert('Notification sent successfully!');
                }
                
            } catch (error) {
                console.error('Error sending notification:', error);
                alert('Failed to send notification: ' + error.message);
            }
        }
        
        // Add notification to UI
        function addNotification(notification, isNew) {
            const element = document.createElement('div');
            element.className = `notification ${notification.type.toLowerCase()}`;
            if (isNew) element.classList.add('new');
            
            element.innerHTML = `
                <div class="d-flex justify-content-between">
                    <strong>${notification.type}</strong>
                    <small>${formatDate(notification.createdAt)}</small>
                </div>
                <p>${notification.payload}</p>
                <small>Status: ${notification.status}</small>
            `;
            
            // Add to container (newest first)
            notificationsContainer.insertBefore(element, notificationsContainer.firstChild);
        }
        
        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'Just now';
            
            const date = new Date(dateString);
            return date.toLocaleString();
        }
    </script>
</body>
</html>